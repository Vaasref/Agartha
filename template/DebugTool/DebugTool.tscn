[gd_scene load_steps=7 format=2]

[ext_resource path="res://template/DebugTool/StackEntry.tscn" type="PackedScene" id=1]

[sub_resource type="GDScript" id=1]
script/source = "extends Button

export var tool_node_path:NodePath
onready var tool_node:Control = get_node(tool_node_path)

func _pressed():
	tool_node.visible = not tool_node.visible
"

[sub_resource type="StyleBoxFlat" id=2]
content_margin_left = 10.0
content_margin_right = 10.0
content_margin_top = 10.0
content_margin_bottom = 10.0
bg_color = Color( 0, 0, 0, 0.2 )

[sub_resource type="GDScript" id=3]
script/source = "extends PanelContainer


export var stack_entry_blank:PackedScene

var dialogue:Dialogue

func _ready():
	var _o = Agartha.connect(\"start_dialogue\", self, '_on_start_dialogue')
	_o = Agartha.connect(\"scene_changed\", self, '_on_scene_changed')
	call_deferred(\"get_dialogue\")

func _process(_delta):
	update_dialogue()

func _on_scene_changed(scene_name):
	$ExecInfo/SceneName/Value.text = scene_name

func _on_start_dialogue(_dialogue_name, _fragment_name):
	call_deferred(\"get_dialogue\")

func get_dialogue():
	for d in get_tree().get_nodes_in_group(\"dialogues\"):
		if d is Dialogue:
			if d.execution_mode == Dialogue.ExecMode.Regular:
				dialogue = d
				break
	update_dialogue()

func update_dialogue(clear:bool=false):
	if dialogue:
		$ExecInfo/DialogueName/Value.text = dialogue.name
		$ExecInfo/DefaultFragment/Value.text = dialogue.default_fragment
		$ExecInfo/Autorun.pressed = dialogue.autorun
		if clear:
			clear_stack()
			for i in dialogue.execution_stack.size():
				var entry = stack_entry_blank.instance().init(i, dialogue.execution_stack[i])
				$EntryList.add_child(entry)
		else:
			while $EntryList.get_children().size() < dialogue.execution_stack.size():
				var entry = stack_entry_blank.instance()
				$EntryList.add_child(entry)
			while $EntryList.get_children().size() > dialogue.execution_stack.size():
				$EntryList.remove_child($EntryList.get_children()[0])
			for i in dialogue.execution_stack.size():
				$EntryList.get_child(i).init(i, dialogue.execution_stack[i])


func clear_stack():
	for c in $EntryList.get_children():
		$EntryList.remove_child(c)
"

[sub_resource type="StyleBoxFlat" id=4]
content_margin_bottom = 10.0
bg_color = Color( 0, 0, 0, 0.2 )
expand_margin_left = 10.0
expand_margin_right = 10.0
expand_margin_top = 10.0

[sub_resource type="StyleBoxEmpty" id=5]
content_margin_top = 10.0

[node name="DebugTool" type="Control"]
anchor_right = 1.0
anchor_bottom = 1.0
margin_left = 1.41418
margin_right = 1.41418
mouse_filter = 2
__meta__ = {
"_edit_use_anchors_": false
}

[node name="ToolButtons" type="HBoxContainer" parent="."]
anchor_right = 1.0
margin_bottom = 30.0
mouse_filter = 2
alignment = 2
__meta__ = {
"_edit_use_anchors_": false
}

[node name="DESButton" type="Button" parent="ToolButtons"]
margin_left = 1115.0
margin_right = 1280.0
margin_bottom = 30.0
text = "Dialogue Execution Tool"
flat = true
script = SubResource( 1 )
__meta__ = {
"_edit_use_anchors_": false
}
tool_node_path = NodePath("../../ScrollContainer/HBoxContainer/DialogueExecStack")

[node name="ScrollContainer" type="ScrollContainer" parent="."]
anchor_left = 0.7
anchor_top = 0.1
anchor_right = 1.0
anchor_bottom = 0.7
mouse_filter = 2
__meta__ = {
"_edit_use_anchors_": false
}

[node name="HBoxContainer" type="HBoxContainer" parent="ScrollContainer"]
margin_right = 384.0
margin_bottom = 432.0
mouse_filter = 2
size_flags_horizontal = 3
size_flags_vertical = 3
alignment = 2
__meta__ = {
"_edit_use_anchors_": false
}

[node name="DialogueExecStack" type="PanelContainer" parent="ScrollContainer/HBoxContainer"]
visible = false
margin_left = 109.0
margin_right = 384.0
margin_bottom = 432.0
mouse_filter = 2
custom_styles/panel = SubResource( 2 )
script = SubResource( 3 )
stack_entry_blank = ExtResource( 1 )

[node name="VBoxContainer" type="VBoxContainer" parent="ScrollContainer/HBoxContainer/DialogueExecStack"]
margin_left = 10.0
margin_top = 10.0
margin_right = 265.0
margin_bottom = 422.0
custom_constants/separation = 5
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Title" type="Label" parent="ScrollContainer/HBoxContainer/DialogueExecStack/VBoxContainer"]
margin_right = 255.0
margin_bottom = 24.0
custom_styles/normal = SubResource( 4 )
text = "Dialogue Execution Tool"

[node name="ExecInfo" type="GridContainer" parent="ScrollContainer/HBoxContainer/DialogueExecStack/VBoxContainer"]
margin_top = 29.0
margin_right = 255.0
margin_bottom = 123.0
custom_constants/vseparation = 10
custom_constants/hseparation = 10
columns = 2
__meta__ = {
"_edit_use_anchors_": false
}

[node name="DialogueName" type="VBoxContainer" parent="ScrollContainer/HBoxContainer/DialogueExecStack/VBoxContainer/ExecInfo"]
margin_right = 114.0
margin_bottom = 42.0
size_flags_horizontal = 3

[node name="Label" type="Label" parent="ScrollContainer/HBoxContainer/DialogueExecStack/VBoxContainer/ExecInfo/DialogueName"]
margin_right = 114.0
margin_bottom = 14.0
text = "DialogueName:"
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Value" type="LineEdit" parent="ScrollContainer/HBoxContainer/DialogueExecStack/VBoxContainer/ExecInfo/DialogueName"]
margin_top = 18.0
margin_right = 114.0
margin_bottom = 42.0
editable = false

[node name="SceneName" type="VBoxContainer" parent="ScrollContainer/HBoxContainer/DialogueExecStack/VBoxContainer/ExecInfo"]
margin_left = 124.0
margin_right = 255.0
margin_bottom = 42.0
size_flags_horizontal = 3

[node name="Label" type="Label" parent="ScrollContainer/HBoxContainer/DialogueExecStack/VBoxContainer/ExecInfo/SceneName"]
margin_right = 131.0
margin_bottom = 14.0
text = "DialogueName:"
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Value" type="LineEdit" parent="ScrollContainer/HBoxContainer/DialogueExecStack/VBoxContainer/ExecInfo/SceneName"]
margin_top = 18.0
margin_right = 131.0
margin_bottom = 42.0
editable = false

[node name="DefaultFragment" type="VBoxContainer" parent="ScrollContainer/HBoxContainer/DialogueExecStack/VBoxContainer/ExecInfo"]
margin_top = 52.0
margin_right = 114.0
margin_bottom = 94.0
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Label" type="Label" parent="ScrollContainer/HBoxContainer/DialogueExecStack/VBoxContainer/ExecInfo/DefaultFragment"]
margin_right = 114.0
margin_bottom = 14.0
text = "Default Fragment:"

[node name="Value" type="LineEdit" parent="ScrollContainer/HBoxContainer/DialogueExecStack/VBoxContainer/ExecInfo/DefaultFragment"]
margin_top = 18.0
margin_right = 114.0
margin_bottom = 42.0
editable = false

[node name="Autorun" type="CheckButton" parent="ScrollContainer/HBoxContainer/DialogueExecStack/VBoxContainer/ExecInfo"]
margin_left = 124.0
margin_top = 52.0
margin_right = 255.0
margin_bottom = 94.0
custom_colors/font_color_disabled = Color( 1, 1, 1, 1 )
disabled = true
text = "Autorun"

[node name="Label" type="Label" parent="ScrollContainer/HBoxContainer/DialogueExecStack/VBoxContainer"]
margin_top = 128.0
margin_right = 255.0
margin_bottom = 152.0
custom_styles/normal = SubResource( 5 )
text = "Execution Stack:"
__meta__ = {
"_edit_use_anchors_": false
}

[node name="EntryList" type="VBoxContainer" parent="ScrollContainer/HBoxContainer/DialogueExecStack/VBoxContainer"]
margin_top = 157.0
margin_right = 255.0
margin_bottom = 178.0
rect_clip_content = true
mouse_filter = 2
__meta__ = {
"_edit_use_anchors_": false
}

[node name="StackEntry" parent="ScrollContainer/HBoxContainer/DialogueExecStack/VBoxContainer/EntryList" instance=ExtResource( 1 )]
margin_right = 255.0
margin_bottom = 21.0
